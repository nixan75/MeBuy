<modification>
	<id>EU VAT Pro - checkout</id>
	<version>2.0.4</version>
	<vqmver>2.1.5</vqmver>
	<author>madimar</author>

<!-- Checkout -->	

	<file name="catalog/view/theme/*/template/checkout/checkout.tpl">
		
		<operation>
            <search position="before" index="1"><![CDATA[
				if (json['error']['warning']) {
            ]]></search>
            <add><![CDATA[
// madimar mod 
				if (json['error']['nonatforeign']) {
					$('.buttons').prepend('</br><div class="warning" style="display: none;">' + json['error']['nonatforeign'] + '</div>');
					
					$('.warning').fadeIn('slow');
				}
				if (json['error']['nonatexempt']) {
					$('.buttons').prepend('</br><div class="warning" style="display: none;">' + json['error']['nonatexempt'] + '</div>');
					
					$('.warning').fadeIn('slow');
				}				
// madimar mod end
            ]]></add>
        </operation>	

		<operation>
            <search position="before" index="1,4"><![CDATA[
				if (json['error']['address_1']) {
            ]]></search>
            <add><![CDATA[
// madimar mod			
				if (json['error']['company']) {
					$('#payment-address input[name=\'company\'] + br').after('<span class="error">' + json['error']['company'] + '</span>');
				}	
				if (json['error']['taxid1']) {
					$('#payment-address input[name=\'taxid1\'] + br').after('<span class="error">' + json['error']['taxid1'] + '</span>');
				}
// v2.0 new error				
				if (json['error']['taxid1_validation']) {
					$('#payment-address input[name=\'taxid1\'] + br').after('<span class="error">' + json['error']['taxid1_validation'] + '</span>');
				}
// v2.0 end				
				if (json['error']['taxid2']) {
					$('#payment-address input[name=\'taxid2\'] + br').after('<span class="error">' + json['error']['taxid2'] + '</span>');
				}					
// madimar mod end
            ]]></add>
        </operation>		
		
<!-- Guest Checkout -->		
		<operation>
            <search position="replace" ><![CDATA[
		data: $('#payment-address input[type=\'text\'], #payment-address input[type=\'checkbox\']:checked, #payment-address select'),
            ]]></search>
            <add><![CDATA[
// madimar mod 
		data: $('#payment-address input[type=\'text\'], #payment-address input[type=\'checkbox\']:checked, #payment-address input[type=\'radio\']:checked, #payment-address select'),			
// madimar mod end
            ]]></add>
        </operation>	

		<operation>
            <search position="before" index="4" ><![CDATA[
			$('.error').remove();
            ]]></search>
            <add><![CDATA[
// madimar mod 
			$('.warning').remove();		
// madimar mod end
            ]]></add>
        </operation>		
		
		<operation>
            <search position="before" index="4"><![CDATA[
				if (json['error']['firstname']) {
            ]]></search>
            <add><![CDATA[
// madimar mod 
				if (json['error']['nonatforeign']) {
					$('.buttons').prepend('</br><div class="warning" style="display: none;">' + json['error']['nonatforeign'] + '</div>');
					
					$('.warning').fadeIn('slow');
				}
				if (json['error']['nonatexempt']) {
					$('.buttons').prepend('</br><div class="warning" style="display: none;">' + json['error']['nonatexempt'] + '</div>');
					
					$('.warning').fadeIn('slow');
				}				
// madimar mod end
            ]]></add>
        </operation>	
				
	</file>

	
<!-- Registration during checkout -->		
	
	<file name="catalog/view/theme/*/template/checkout/register.tpl">
		<operation>
            <search position="before"><![CDATA[
			<div class="left">
            ]]></search>
            <add><![CDATA[
<!-- madimar mod -->
<?php if ($num_cust_tax_groups > 1) { ?>
<div id="cust-tax-category">
<h2><?php echo $text_your_tax_category; ?></h2>
	<p><?php echo $text_tax_category; ?></p>
	<?php foreach ($cust_tax_groups as $cust_tax_group) { ?>
		<label for="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" style="cursor: pointer; vertical-align: middle;" >
			<?php if ($cust_tax_group['cust_tax_group_id'] == $cust_tax_group_id) { ?>
				<input type="radio" name="cust_tax_group_id" value="<?php echo $cust_tax_group['cust_tax_group_id']; ?>" id="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" checked="checked"  style="vertical-align: middle;"  onClick="hide_show_us(<?php echo $cust_tax_group['cust_tax_group_id'] ?>)" /> <?php echo $cust_tax_group['name']; ?>  
				<br />
				<div style="color: #999; display: block; font-size: 12px; " ><?php echo $cust_tax_group['description']; ?></div>
		</label>
		<br />
            <?php } else { ?>
				<input type="radio" name="cust_tax_group_id" value="<?php echo $cust_tax_group['cust_tax_group_id']; ?>" id="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" style="vertical-align: middle;"  onClick="hide_show_us(<?php echo $cust_tax_group['cust_tax_group_id'] ?>)" /> <?php echo $cust_tax_group['name']; ?>  
				<br />
				<div style="color: #999; display:block; font-size: 12px; " ><?php echo $cust_tax_group['description']; ?> </div></label>
		<br />		
            <?php } ?>
    <?php } ?>
</div>				
<br />	
<?php } ?>
<!-- madimar mod end -->
            ]]></add>
        </operation>

		<operation>
            <search position="replace"  index="1" offset="5"><![CDATA[
<div class="right">
            ]]></search>
            <add><![CDATA[
<!-- madimar mod -->
<div class="right">
  <h2><?php echo $text_your_address; ?></h2>
		  <?php if ($cust_tax_group_id <> 1) { ?>
		  <div id="cmpn" >
		  <?php } else { ?>
		  <div id="cmpn" style="display: none;">
		  <?php } ?>
			  <span class="required">*</span> <?php echo $entry_company; ?><br />
			  <input type="text" name="company" value="" class="large-field" />
			  <br />
			  <br />
		  </div>  

		  <?php if ($cust_tax_group_id == 2) { ?> 	
		  <div id="taxid1" >
		    <span id="taxid1R" class="required">* </span>
		  <?php } elseif ($cust_tax_group_id == 3) { ?> 	
		  <div id="taxid1" >
		    <span id="taxid1R" style="display: none;" class="required">* </span>
			<?php } else { ?>		  
		  <div id="taxid1" style="display: none;">
		    <span id="taxid1R" class="required">* </span>		  
		  <?php } ?>
		  <?php echo $entry_taxid1; ?><br />
            <input type="text" name="taxid1" value="" class="large-field" />
			  <br />
			  <br />			
		  </div> 
<!-- CF -->		  
<?php	switch ($this->config->get('config_country_id')) { 
		// Italy	
		case "105" :	
		// Spain	
		case "195" : ?>	
		  <?php if ($cust_tax_group_id == 1) { ?> 	
		  <div id="taxid2" >
		    <span id="taxid2R" class="required">* </span>
		  <?php } elseif ($cust_tax_group_id == 2) { ?> 	
		  <div id="taxid2" >
		    <span id="taxid2R" style="display: none;" class="required">* </span>
			<?php } else { ?>		  
		  <div id="taxid2" style="display: none;">
		    <span id="taxid2R" class="required">* </span>		  
		  <?php } ?>
		  <?php echo $entry_taxid2; ?><br />
            <input type="text" name="taxid2" value="" class="large-field" />
			  <br />
			  <br />			
          </div>
<?php	break;
		
		// Default - France: 73 - Germany: 81 - UK: 222 
		default : 				
		break;	
		} ?>		
<!-- madimar mod end -->
            ]]></add>
        </operation>
		
		<operation>
            <search position="after"><![CDATA[
//--></script>
            ]]></search>
            <add><![CDATA[
<script type="text/javascript"><!--
function hide_show_us(ctgi)
{
switch (ctgi) {
				case 1 :
				document.getElementById('cmpn').style.display="none";
				document.getElementById('taxid1').style.display="none";
				document.getElementById('taxid1R').style.display="none";
				document.getElementById('taxid2').style.display="";
				document.getElementById('taxid2R').style.display="";				
				break
			   
				case 2 :
				document.getElementById('cmpn').style.display="";
				document.getElementById('taxid1').style.display="";
				document.getElementById('taxid1R').style.display="";
				document.getElementById('taxid2').style.display="";
				document.getElementById('taxid2R').style.display="none";	
				break
				
				case 3 :
				document.getElementById('cmpn').style.display="";
				document.getElementById('taxid1').style.display="";
				document.getElementById('taxid1R').style.display="none";
				document.getElementById('taxid2').style.display="none";
				document.getElementById('taxid2R').style.display="none";	
				break

				default :
				document.getElementById('cmpn').style.display="none";
				document.getElementById('taxid1').style.display="none";
				document.getElementById('taxid1R').style.display="none";				
				document.getElementById('taxid2').style.display="none";
				document.getElementById('taxid2R').style.display="none";	
				break				
				}
}
//--></script>
            ]]></add>
        </operation>	

	</file>	
	
	<file name="catalog/controller/checkout/register.php">
<!-- v2.0 auto customer group -->
		<operation>
            <search position="before"><![CDATA[
			$this->model_account_customer->addCustomer($this->request->post);
            ]]></search>
            <add><![CDATA[
// madimar mod
// v2.0 auto customer group
		$this->load->model('account/customer_tax_group');
		$cust_tax_group = $this->model_account_customer_tax_group->getCustomerTaxGroup((int)$this->request->post['cust_tax_group_id']);
		$this->request->post['default_customer_group_id'] = $cust_tax_group['default_customer_group_id'];	
// madimar mod end
            ]]></add>
        </operation>		
	
		<operation>
            <search position="before"><![CDATA[
    	$this->data['text_your_details'] = $this->language->get('text_your_details');
            ]]></search>
            <add><![CDATA[
// madimar mod
    	$this->data['text_your_tax_category'] = $this->language->get('text_your_tax_category');
// madimar mod fine
            ]]></add>
        </operation>
		
		<operation>
            <search position="after"><![CDATA[
    	$this->data['entry_zone'] = $this->language->get('entry_zone');
            ]]></search>
            <add><![CDATA[
// madimar mod
		$this->data['entry_taxid1'] = $this->language->get('entry_taxid1');
		$this->data['entry_taxid2'] = $this->language->get('entry_taxid2');
    	$this->data['entry_cust_tax_group'] = $this->language->get('entry_cust_tax_group');		
    	$this->data['text_tax_category'] = $this->language->get('text_tax_category');

		if (isset($this->request->post['taxid1'])) {
      		$this->data['taxid1'] = $this->request->post['taxid1'];
    	} else {
      		$this->data['taxid1'] = '';
    	}
		if (isset($this->request->post['taxid2'])) {
      		$this->data['taxid2'] = $this->request->post['taxid2'];
    	} else {
      		$this->data['taxid2'] = '';
    	}
		if (isset($this->request->post['cust_tax_group_id'])) {
      		$this->data['cust_tax_group_id'] = $this->request->post['cust_tax_group_id'];
    	} else {
			$this->data['cust_tax_group_id'] = $this->data['default_tax_group'];
    	}		
// madimar mod end
            ]]></add>
        </operation>
		
		<operation>
            <search position="before"><![CDATA[
		$this->load->model('account/customer');
            ]]></search>
            <add><![CDATA[
// madimar mod 
		$this->load->model('account/customer_tax_group');
		
    	$this->data['cust_tax_groups'] = $this->model_account_customer_tax_group->getCustomerTaxGroups();
    	$this->data['num_cust_tax_groups'] = $this->model_account_customer_tax_group->getTotalCustomerTaxGroups();
// v2.0 bug fix offset = 0		
		$this->data['default_tax_group'] = 0;
		if ($this->data['num_cust_tax_groups']) $this->data['default_tax_group'] = $this->data['cust_tax_groups'][0]['cust_tax_group_id'];
		
// madimar mod fine  
		]]></add>
        </operation>

		<operation>
            <search position="before"><![CDATA[
				if ((utf8_strlen($this->request->post['firstname']) < 1) || (utf8_strlen($this->request->post['firstname']) > 32)) {
            ]]></search>
            <add><![CDATA[
// madimar mod	
// v2.0 VAT Web Check
	$this->load->model('localisation/country');
		
	$country_info = $this->model_localisation_country->getCountry($this->request->post['country_id']);
	$iso_code = $country_info['iso_code_2'];
    $this->load->library('vatnumber');
// compliancy checks		
		switch ($this->request->post['cust_tax_group_id']) {
			case "1" :
			switch ($this->config->get('config_country_id')) {
				// Italy
				case "105" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					// Controllo CF
					if (!$this->request->post['taxid2'] || !vatnumber::checkCF($this->request->post['taxid2'])) {
						$json['error']['taxid2'] = $this->language->get('error_taxid2');
					}		
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (!isset($this->request->post['taxid2'])) 
						$this->request->post['taxid2'] = "";					
				}
				break;
				
				// Spain
				case "195" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (vatnumber::valida_nif_cif_nie($this->request->post['taxid2']) == -1 || vatnumber::valida_nif_cif_nie($this->request->post['taxid2']) == 0) {
						$json['error']['taxid2'] = $this->language->get('error_taxid2');
					}
					
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (!isset($this->request->post['taxid2'])) 
						$this->request->post['taxid2'] = "";					
				}
				break;		

				// Default - France: 73 - Germany: 81 - UK: 222
				default : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					$this->request->post['taxid2'] = "";					
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";	
					$this->request->post['taxid2'] = "";					
				}
				break;
			}				
			break;		
		
			case "2" :
			switch ($this->config->get('config_country_id')) {
				// Italy
				case "105" : 			
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {			
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					  
					// Controllo CF opzionale solo se non vuoto es. Libero Professionista
					if (!empty($this->request->post['taxid2'])) {
						if (!vatnumber::checkCF($this->request->post['taxid2'])) {
							$json['error']['taxid2'] = $this->language->get('error_taxid2');
						}
					}	
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;
				
				// Spain
				case "195" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {

					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					
					$this->request->post['taxid2'] = "";	
					
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;

				// Default - France: 73 - Germany: 81 - UK: 222
				default : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
				
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					$this->request->post['taxid2'] = "";	
					
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;
			}				
			
			break;			

			case "3" :
			if ($this->request->post['country_id'] != (int)$this->config->get('config_country_id')) {			
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (!empty($this->request->post['taxid1'])) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					$this->request->post['taxid2'] = "";	
				
			} else {
				// se selezionato ma nazionale
				$json['error']['nonatexempt'] = $this->language->get('error_nonatexempt');		
			}
			break;	
		}	
// madimar mod fine

            ]]></add>
        </operation>
		
	</file>		

<!-- Model Order -->

	<file name="catalog/model/checkout/order.php">
		<operation>
            <search position="after"><![CDATA[
		$order_id = $this->db->getLastId();
		]]></search>
            <add><![CDATA[
// madimar mod
		$this->db->query("UPDATE `" . DB_PREFIX . "order` SET payment_taxid1 = '" . $this->db->escape($data['payment_taxid1']) . "', payment_taxid2 = '" . $this->db->escape($data['payment_taxid2']) . "', " ."date_modified = NOW(), date_added = NOW() WHERE order_id = '" . (int)$order_id . "'");
// madimar mod end
		]]></add>
        </operation>

		<operation>
            <search position="after"><![CDATA[
				'payment_method'          => $order_query->row['payment_method'],
		]]></search>
            <add><![CDATA[
// madimar mod
				'payment_taxid1'          => $order_query->row['payment_taxid1'],
				'payment_taxid2'          => $order_query->row['payment_taxid2'],				
// madimar mod end
		]]></add>
        </operation>		
		
		<operation>
            <search position="after"><![CDATA[
			$template->data['text_powered'] = $language->get('text_new_powered');
            ]]></search>
            <add><![CDATA[
				// madimar mod			
			$template->data['text_taxid1'] = $language->get('text_taxid1');
			$template->data['text_taxid2'] = $language->get('text_taxid2');
				// madimar mod end
				]]></add>
        </operation>	
		
		<operation>
            <search position="before" index="2"><![CDATA[
			$find = array(
            ]]></search>
            <add><![CDATA[
// madimar mod
		if( strlen($order_info['payment_taxid1']) ) 
          $format .= "\n" . $template->data['text_taxid1'] . " " . '{taxid1}'; 
		if( strlen($order_info['payment_taxid2']) ) 
          $format .= "\n" . $template->data['text_taxid2'] . " " . '{taxid2}'; 
		  // madimar mod end		
				]]></add>
        </operation>		
		
		<operation>
            <search position="replace" index="4"><![CDATA[
				'{country}'
            ]]></search>
            <add><![CDATA[
				'{country}',
// madimar mod
				'{taxid1}',			
				'{taxid2}'	
				// madimar mod end
				]]></add>
        </operation>
		
		<operation>
            <search position="replace"><![CDATA[
				'country'   => $order_info['payment_country']  
            ]]></search>
            <add><![CDATA[
				'country'   => $order_info['payment_country'],
// madimar mod
				'taxid1'   => $order_info['payment_taxid1'],
				'taxid2'   => $order_info['payment_taxid2']
				// madimar mod end
				]]></add>
        </operation>	

	</file>	
	
<!-- Payment Address -->	

	<file name="catalog/controller/checkout/address.php">
		<operation>
            <search position="replace" index="1"><![CDATA[
			$this->data['addresses'] = $this->model_account_address->getAddresses();
            ]]></search>
            <add><![CDATA[
			// madimar mod
//			$this->data['addresses'] = $this->model_account_address->getAddresses();
			$this->data['addresses'] = $this->model_account_address->getPaymentAddress();			
			// madimar mod fine
            ]]></add>
        </operation>
<!-- v2.0.4 -->
		<operation>
            <search position="after" ><![CDATA[
			$this->data['text_select'] = $this->language->get('text_select');
			]]></search>
            <add><![CDATA[
			// madimar mod
			$this->data['text_taxid1'] = $this->language->get('text_taxid1');
			$this->data['text_taxid2'] = $this->language->get('text_taxid2');			
			// madimar mod fine
			]]></add>
        </operation>		
		
		<operation>
            <search position="replace" index="1,2,3" ><![CDATA[address.tpl]]></search>
            <add><![CDATA[paddress.tpl]]></add>
        </operation>	
		
	</file>	

	<file name="catalog/controller/checkout/confirm.php">
		<operation>
            <search position="after"><![CDATA[
				$payment_address = $this->model_account_address->getAddress($this->session->data['payment_address_id']);
            ]]></search>
            <add><![CDATA[
			// madimar mod
		$this->load->model('account/customer');
//   		$payment_address = $this->model_account_customer->getCustomer($this->customer->getId());		
		$payment_address += $this->model_account_customer->getPaymentAddress($this->customer->getId());		
			// madimar mod fine
            ]]></add>
        </operation>

	<operation>
        <search position="after"><![CDATA[
			$data['payment_address_format'] = $payment_address['address_format'];
        ]]></search>
        <add><![CDATA[
// madimar mod
			$data['payment_taxid1'] = $payment_address['taxid1'];
			$data['payment_taxid2'] = $payment_address['taxid2'];
// madimar mod end
        ]]></add>
    </operation>		

	</file>
	
	
<!-- Guest Checkout -->
	
	<file name="catalog/controller/checkout/guest.php">

		<operation>
            <search position="after" index="1"><![CDATA[
    	$this->language->load('checkout/checkout');
            ]]></search>
            <add><![CDATA[
// madimar mod 
		$this->load->model('account/customer_tax_group');
		
    	$this->data['cust_tax_groups'] = $this->model_account_customer_tax_group->getCustomerTaxGroups();

    	$this->data['num_cust_tax_groups'] = $this->model_account_customer_tax_group->getTotalCustomerTaxGroups();
// v2.0 bug fix offset = 0	
		$this->data['default_tax_group'] = 0;	
		if ($this->data['num_cust_tax_groups']) $this->data['default_tax_group'] = $this->data['cust_tax_groups'][0]['cust_tax_group_id'];
	
// madimar mod fine  
		]]></add>
        </operation>

		<operation>
            <search position="before"><![CDATA[
    	$this->data['text_your_details'] = $this->language->get('text_your_details');
            ]]></search>
            <add><![CDATA[
// madimar mod
    	$this->data['text_your_tax_category'] = $this->language->get('text_your_tax_category');
// madimar mod fine
            ]]></add>
        </operation>

		<operation>
            <search position="after"><![CDATA[
				$this->session->data['guest']['fax'] = $this->request->post['fax'];
            ]]></search>
            <add><![CDATA[
// madimar mod
		if (isset($this->request->post['cust_tax_group_id'])) {
				$this->session->data['guest']['cust_tax_group_id'] = $this->request->post['cust_tax_group_id'];
				
    	} else {
				$this->session->data['guest']['cust_tax_group_id'] = '';
    	}
		if (isset($this->request->post['taxid1'])) {
				$this->session->data['guest']['payment']['taxid1'] = $this->request->post['taxid1'];
    	} else {
				$this->session->data['guest']['payment']['taxid1'] = '';
    	}
		if (isset($this->request->post['taxid1'])) {
				$this->session->data['guest']['payment']['taxid2'] = $this->request->post['taxid2'];	
    	} else {
				$this->session->data['guest']['payment']['taxid2'] = '';	
    	}				
// madimar mod fine
            ]]></add>
        </operation>

		
		<operation>
            <search position="after" index="1"><![CDATA[
    	$this->data['entry_zone'] = $this->language->get('entry_zone');
            ]]></search>
            <add><![CDATA[
// madimar mod
		$this->data['entry_taxid1'] = $this->language->get('entry_taxid1');
		$this->data['entry_taxid2'] = $this->language->get('entry_taxid2');
    	$this->data['entry_cust_tax_group'] = $this->language->get('entry_cust_tax_group');		
    	$this->data['text_tax_category'] = $this->language->get('text_tax_category');		
// madimar mod end
            ]]></add>
        </operation>
		
		<operation>
            <search position="before" index="1"><![CDATA[
				if ((utf8_strlen($this->request->post['firstname']) < 1) || (utf8_strlen($this->request->post['firstname']) > 32)) {
            ]]></search>
            <add><![CDATA[
// madimar mod	
// v2.0 VAT Web Check
	$this->load->model('localisation/country');
		
	$country_info = $this->model_localisation_country->getCountry($this->request->post['country_id']);
	$iso_code = $country_info['iso_code_2'];
    $this->load->library('vatnumber');
// compliancy checks		
		switch ($this->request->post['cust_tax_group_id']) {
			case "1" :
			switch ($this->config->get('config_country_id')) {
				// Italy
				case "105" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					// Controllo CF
					if (!$this->request->post['taxid2'] || !vatnumber::checkCF($this->request->post['taxid2'])) {
						$json['error']['taxid2'] = $this->language->get('error_taxid2');
					}		
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (!isset($this->request->post['taxid2'])) 
						$this->request->post['taxid2'] = "";					
				}
				break;
				
				// Spain
				case "195" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (vatnumber::valida_nif_cif_nie($this->request->post['taxid2']) == -1 || vatnumber::valida_nif_cif_nie($this->request->post['taxid2']) == 0) {
						$json['error']['taxid2'] = $this->language->get('error_taxid2');
					}
					
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					if (!isset($this->request->post['taxid2'])) 
						$this->request->post['taxid2'] = "";					
				}
				break;		

				// Default - France: 73 - Germany: 81 - UK: 222
				default : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";
					$this->request->post['taxid2'] = "";					
				} else {
				// se privato straniero, non necessario CF
					$this->request->post['company'] = "";
					$this->request->post['taxid1'] = "";	
					$this->request->post['taxid2'] = "";					
				}
				break;
			}				
			break;		
		
			case "2" :
			switch ($this->config->get('config_country_id')) {
				// Italy
				case "105" : 			
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {			
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					  
					// Controllo CF opzionale solo se non vuoto es. Libero Professionista
					if (!empty($this->request->post['taxid2'])) {
						if (!vatnumber::checkCF($this->request->post['taxid2'])) {
							$json['error']['taxid2'] = $this->language->get('error_taxid2');
						}
					}	
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;
				
				// Spain
				case "195" : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {

					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					
					$this->request->post['taxid2'] = "";	
					
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;

				// Default - France: 73 - Germany: 81 - UK: 222
				default : 
				if ($this->request->post['country_id'] == (int)$this->config->get('config_country_id')) {
				
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (1) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					$this->request->post['taxid2'] = "";	
					
				} else {
				// se selezionato ma straniero
				$json['error']['nonatforeign'] = $this->language->get('error_nonatforeign');		
				}
				break;
			}				
			
			break;			

			case "3" :
			if ($this->request->post['country_id'] != (int)$this->config->get('config_country_id')) {			
					if ((strlen(utf8_decode($this->request->post['company'])) < 3) || (strlen(utf8_decode($this->request->post['company'])) > 32)) {
						$json['error']['company'] = $this->language->get('error_company');
					}
					// Controllo VAT Number
					if (!empty($this->request->post['taxid1'])) {
						$check = vatnumber::check($this->request->post['taxid1'],$iso_code);
						
						if ($check == false) {
							$json['error']['taxid1'] = $this->language->get('error_taxid1');
						} elseif ($check == -1 && !$this->config->get('config_vat_web_check_unavail')) {
							$json['error']['taxid1_validation'] = $this->language->get('error_taxid1_validation');
						} elseif ($check == -1 && $this->config->get('config_vat_web_check_unavail')) {
							$this->request->post['vat_checked'] = 0;
						} else {
							$this->request->post['vat_checked'] = 1;
						}
					}
					$this->request->post['taxid2'] = "";	
				
			} else {
				// se selezionato ma nazionale
				$json['error']['nonatexempt'] = $this->language->get('error_nonatexempt');		
			}
			break;	
		}	
// madimar mod fine
            ]]></add>
        </operation>
		
		<operation>
            <search position="after"><![CDATA[
			$this->data['button_continue'] = $this->language->get('button_continue');
            ]]></search>
            <add><![CDATA[
// madimar mod
			if (isset($this->session->data['guest']['cust_tax_group_id'])) {
				$this->data['cust_tax_group_id'] = $this->session->data['guest']['cust_tax_group_id'];			
			} else {
				$this->data['cust_tax_group_id'] = $this->data['default_tax_group'];
			}
// madimar mod end  		
            ]]></add>
        </operation>		
			
		<operation>
            <search position="before"><![CDATA[
			if (isset($this->session->data['guest']['payment']['company'])) {
            ]]></search>
            <add><![CDATA[
// madimar mod
			if (isset($this->session->data['guest']['payment']['taxid1'])) {
				$this->data['taxid1'] = $this->session->data['guest']['payment']['taxid1'];			
			} else {
				$this->data['taxid1'] = '';
			}

			if (isset($this->session->data['guest']['payment']['taxid2'])) {
				$this->data['taxid2'] = $this->session->data['guest']['payment']['taxid2'];			
			} else {
				$this->data['taxid2'] = '';
			}		
// madimar mod end  		
            ]]></add>
        </operation>		
		
	</file>		

	<file name="catalog/view/theme/*/template/checkout/guest.tpl">
		<operation>
            <search position="before"><![CDATA[
			<div class="left">
            ]]></search>
            <add><![CDATA[
<!-- madimar mod -->
<?php if ($num_cust_tax_groups > 1) { ?>
<div id="cust-tax-category">
<h2><?php echo $text_your_tax_category; ?></h2>
		<p><?php echo $text_tax_category; ?></p>
                <?php foreach ($cust_tax_groups as $cust_tax_group) { ?>
				<label for="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" style="cursor: pointer; vertical-align: middle;" >
                <?php if ($cust_tax_group['cust_tax_group_id'] == $cust_tax_group_id) { ?>
				<input type="radio" name="cust_tax_group_id" value="<?php echo $cust_tax_group['cust_tax_group_id']; ?>" id="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" checked="checked"  style="vertical-align: middle;"  onClick="hide_show_us(<?php echo $cust_tax_group['cust_tax_group_id'] ?>)" /> <?php echo $cust_tax_group['name']; ?>  
				<br />
				<div style="color: #999; display: block; font-size: 12px; " ><?php echo $cust_tax_group['description']; ?> </div></label>
<br />
                <?php } else { ?>
				<input type="radio" name="cust_tax_group_id" value="<?php echo $cust_tax_group['cust_tax_group_id']; ?>" id="ctgid<?php echo $cust_tax_group['cust_tax_group_id']; ?>" style="vertical-align: middle;"  onClick="hide_show_us(<?php echo $cust_tax_group['cust_tax_group_id'] ?>)" /> <?php echo $cust_tax_group['name']; ?>  
				<br />
				<div style="color: #999; display:block; font-size: 12px; " ><?php echo $cust_tax_group['description']; ?> </div></label>
<br />				
                <?php } ?>
                <?php } ?>
</div>				
<br />
<?php } ?>			
<!-- madimar mod end -->
            ]]></add>
        </operation>


		<operation>
            <search position="replace"  index="1" offset="5"><![CDATA[
<div class="right">
            ]]></search>
            <add><![CDATA[
<!-- madimar mod -->
<div class="right">
  <h2><?php echo $text_your_address; ?></h2>
		  <?php if ($cust_tax_group_id <> 1) { ?>
		  <div id="cmpn" >
		  <?php } else { ?>
		  <div id="cmpn" style="display: none;">
		  <?php } ?>
			  <span class="required">*</span> <?php echo $entry_company; ?><br />
			  <input type="text" name="company" value="" class="large-field" />
			  <br />
			  <br />
		  </div>  

		  <?php if ($cust_tax_group_id == 2) { ?> 	
		  <div id="taxid1" >
		    <span id="taxid1R" class="required">* </span>
		  <?php } elseif ($cust_tax_group_id == 3) { ?> 	
		  <div id="taxid1" >
		    <span id="taxid1R" style="display: none;" class="required">* </span>
			<?php } else { ?>		  
		  <div id="taxid1" style="display: none;">
		    <span id="taxid1R" class="required">* </span>		  
		  <?php } ?>
		  <?php echo $entry_taxid1; ?><br />
            <input type="text" name="taxid1" value="" class="large-field" />
			  <br />
			  <br />			
		  </div> 
<!-- CF -->		 
<?php	switch ($this->config->get('config_country_id')) { 
		// Italy	
		case "105" :	
		// Spain	
		case "195" : ?>		 
		  <?php if ($cust_tax_group_id == 1) { ?> 	
		  <div id="taxid2" >
		    <span id="taxid2R" class="required">* </span>
		  <?php } elseif ($cust_tax_group_id == 2) { ?> 	
		  <div id="taxid2" >
		    <span id="taxid2R" style="display: none;" class="required">* </span>
			<?php } else { ?>		  
		  <div id="taxid2" style="display: none;">
		    <span id="taxid2R" class="required">* </span>		  
		  <?php } ?>
		  <?php echo $entry_taxid2; ?><br />
            <input type="text" name="taxid2" value="" class="large-field" />
			  <br />
			  <br />			
          </div>
	<?php	break;	
		// Default - France: 73 - Germany: 81 - UK: 222 
		default :	
		break;
		}	?> 			  
<!-- madimar mod end -->
            ]]></add>
        </operation>
		
		<operation>
            <search position="after" index="1"><![CDATA[
//--></script>
            ]]></search>
            <add><![CDATA[
<script type="text/javascript"><!--
function hide_show_us(ctgi)
{
switch (ctgi) {
				case 1 :
				document.getElementById('cmpn').style.display="none";
				document.getElementById('taxid1').style.display="none";
				document.getElementById('taxid1R').style.display="none";
				document.getElementById('taxid2').style.display="";
				document.getElementById('taxid2R').style.display="";				
				break
			   
				case 2 :
				document.getElementById('cmpn').style.display="";
				document.getElementById('taxid1').style.display="";
				document.getElementById('taxid1R').style.display="";
				document.getElementById('taxid2').style.display="";
				document.getElementById('taxid2R').style.display="none";	
				break
				
				case 3 :
				document.getElementById('cmpn').style.display="";
				document.getElementById('taxid1').style.display="";
				document.getElementById('taxid1R').style.display="none";
				document.getElementById('taxid2').style.display="none";
				document.getElementById('taxid2R').style.display="none";	
				break

				default :
				document.getElementById('cmpn').style.display="none";
				document.getElementById('taxid1').style.display="none";
				document.getElementById('taxid1R').style.display="none";				
				document.getElementById('taxid2').style.display="none";
				document.getElementById('taxid2R').style.display="none";	
				break				
				}
}
//--></script>
            ]]></add>
        </operation>	

	</file>	

</modification>